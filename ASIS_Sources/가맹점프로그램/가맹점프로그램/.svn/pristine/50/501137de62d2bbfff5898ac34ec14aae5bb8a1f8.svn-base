Attribute VB_Name = "basBizPurio"
' Biz Purio 용 문자발신 모듈
Option Explicit
Dim SMSCon As ADODB.Connection


' 가입안내 문자전송
Public Sub send_Kakao_Invite(str_Customer_Phone As String)
    Dim sSql As String
    sSql = ""
    sSql = sSql & " INSERT INTO biz_purio..biz_msg (MSG_TYPE, CMID, REQUEST_TIME, SEND_TIME, DEST_PHONE, SEND_PHONE,"
    sSql = sSql & " MSG_BODY, TEMPLATE_CODE, SENDER_KEY, NATION_CODE,"
    sSql = sSql & " RE_TYPE, RE_BODY, SHOP_CODE)"
    sSql = sSql & " VALUES ("
    sSql = sSql & " 6, "
    sSql = sSql & " Convert(varchar(10),Getdate(),112) + Replace(Convert(varchar(8),Getdate(),108),':',''), "
    sSql = sSql & " Getdate(), "
    sSql = sSql & " Getdate(), "
    sSql = sSql & " '" & str_Customer_Phone & "', "
    sSql = sSql & " '" & 가맹점정보.전화SMS & "',"
    sSql = sSql & " '[세탁 완료 안내]" & vbCrLf
    sSql = sSql & vbCrLf
    sSql = sSql & "안녕하세요." & vbCrLf
    sSql = sSql & "고객님께서 맡기신 소중한" & vbCrLf
    sSql = sSql & "세탁물의 세탁이 완료되었습니다." & vbCrLf
    sSql = sSql & "수령 부탁드립니다." & vbCrLf
    sSql = sSql & vbCrLf
    sSql = sSql & "가맹점 : " & 가맹점정보.가맹점명 & "" & vbCrLf
    sSql = sSql & "문의 : " & 가맹점정보.전화매장 & "', "
    sSql = sSql & " 'bizp_2018120409581704807569091', "
    sSql = sSql & " 'f100882941d6ad62b2b383e6559c61f32208981a', "
    sSql = sSql & " '82',"
    sSql = sSql & " 'SMS', "
    sSql = sSql & " '안녕하세요."
    sSql = sSql & " 고객님께서 맡기신 소중한"
    sSql = sSql & " 세탁물의 세탁이 완료되었습니다"
    sSql = sSql & " 감사합니다가맹점입니다',"
    sSql = sSql & "'" & 가맹점정보.가맹점코드 & "'"
    sSql = sSql & ")"
    If CheckConnect Then
        SMSCon.Execute sSql
        Call MsgBox("가입 안내문이 카카오톡으로 전송되었습니다.")
    End If
End Sub


' 배송안내 문자전송
Public Sub send_Kakao_Delivery(str_Customer_Phone As String)
    Dim sSql As String
    sSql = ""
    sSql = sSql & " INSERT INTO biz_purio..biz_msg (MSG_TYPE, CMID, REQUEST_TIME, SEND_TIME, DEST_PHONE, SEND_PHONE,"
    sSql = sSql & " MSG_BODY, TEMPLATE_CODE, SENDER_KEY, NATION_CODE,"
    sSql = sSql & " RE_TYPE, RE_BODY, SHOP_CODE)"
    sSql = sSql & " VALUES ("
    sSql = sSql & " 6, "
    sSql = sSql & " Convert(varchar(10),Getdate(),112) + Replace(Convert(varchar(8),Getdate(),108),':',''), "
    sSql = sSql & " Getdate(), "
    sSql = sSql & " Getdate(), "
    sSql = sSql & " '" & str_Customer_Phone & "', "
    sSql = sSql & " '" & 가맹점정보.전화SMS & "',"
    sSql = sSql & " '[세탁 완료 안내]" & vbCrLf
    sSql = sSql & vbCrLf
    sSql = sSql & "안녕하세요." & vbCrLf
    sSql = sSql & "고객님께서 맡기신 소중한" & vbCrLf
    sSql = sSql & "세탁물의 세탁이 완료되었습니다." & vbCrLf
    sSql = sSql & "수령 부탁드립니다." & vbCrLf
    sSql = sSql & vbCrLf
    sSql = sSql & "가맹점 : " & 가맹점정보.가맹점명 & "" & vbCrLf
    sSql = sSql & "문의 : " & 가맹점정보.전화매장 & "', "
    sSql = sSql & " 'bizp_2018120409581704807569091', "
    sSql = sSql & " 'f100882941d6ad62b2b383e6559c61f32208981a', "
    sSql = sSql & " '82',"
    sSql = sSql & " 'SMS', "
    sSql = sSql & "'안녕하세요."
    sSql = sSql & "고객님께서 맡기신 소중한"
    sSql = sSql & "세탁물의 세탁이 완료되었습니다"
    sSql = sSql & "감사합니다가맹점입니다',"
    sSql = sSql & "'" & 가맹점정보.가맹점코드 & "'"
    sSql = sSql & ")"
    If CheckConnect Then
        SMSCon.Execute sSql
    End If
End Sub



' 친구톡 문자전송
Public Sub send_Kakao_Friend(str_Customer_Phone As String, str_Message As String)
    Dim sSql As String
    sSql = ""
    sSql = sSql & " INSERT INTO biz_purio..biz_msg (MSG_TYPE, CMID, REQUEST_TIME, SEND_TIME, DEST_PHONE, SEND_PHONE,"
    sSql = sSql & " MSG_BODY, SENDER_KEY, NATION_CODE,SHOP_CODE)"
    sSql = sSql & " VALUES ("
    sSql = sSql & " 7, "
    sSql = sSql & " Convert(varchar(10),Getdate(),112) + Replace(Convert(varchar(8),Getdate(),108),':',''), "
    sSql = sSql & " Getdate(), "
    sSql = sSql & " Getdate(), "
    sSql = sSql & " '" & str_Customer_Phone & "', "
    sSql = sSql & " '" & 가맹점정보.전화SMS & "',"
    sSql = sSql & " '" & str_Message & "', "
    sSql = sSql & " 'f100882941d6ad62b2b383e6559c61f32208981a',"
    sSql = sSql & " '82',"
    sSql = sSql & " '" & 가맹점정보.가맹점코드 & "'"
    sSql = sSql & " )"
    If CheckConnect Then
        SMSCon.Execute sSql
    End If
End Sub


Public Function GetMoney() As String
On Error GoTo ErrRtn
    Dim sSql As String
    Dim TempMoney As Long
    
    If Not CheckConnect Then
        GoTo ErrRtn
    End If
    
    Dim RecordSet As ADODB.RecordSet
    sSql = "SELECT SUM(MONEY) as MONEY FROM [BIZ_PURIO].[dbo].TBL_SMS_MONEY WHERE SHOP_CODE = '" & 가맹점정보.가맹점코드 & "'"
    Set RecordSet = SMSCon.Execute(sSql)
    If Not RecordSet.EOF Then
        TempMoney = Val(RecordSet!Money)
    End If
    GetMoney = CStr(TempMoney)
    Exit Function
ErrRtn:
    GetMoney = "0"
'    MsgBox "Error " & Err.Number & " (" & Err.description & ") in procedure CheckConnect of Module basBizPurio"
End Function

Public Function GetMsgList() As ADODB.RecordSet
On Error GoTo ErrRtn
    Dim sSql As String
    
    If Not CheckConnect Then
        GoTo ErrRtn
    End If
    
    Dim RecordSet As ADODB.RecordSet
    sSql = "SELECT * FROM [BIZ_PURIO].[dbo].TBL_SMS_MSG WHERE SHOP_CODE = '" & 가맹점정보.가맹점코드 & "' ORDER BY MSG_ID"
    Set GetMsgList = SMSCon.Execute(sSql)
    Exit Function
ErrRtn:
    Set GetMsgList = Nothing
End Function

Public Function GetMsg(MsgID As String) As ADODB.RecordSet
On Error GoTo ErrRtn
    Dim sSql As String
    
    If Not CheckConnect Then
        GoTo ErrRtn
    End If
    
    Dim RecordSet As ADODB.RecordSet
    sSql = "SELECT * FROM [BIZ_PURIO].[dbo].TBL_SMS_MSG WHERE SHOP_CODE = '" & 가맹점정보.가맹점코드 & "' AND MSG_ID = " & MsgID
    Set GetMsg = SMSCon.Execute(sSql)
    Exit Function
ErrRtn:
    Set GetMsg = Nothing
    
End Function

Public Function SaveKaKaoMsg(MsgID As String, title As String, msg As String) As Boolean
On Error GoTo ErrRtn
    Dim sSql As String
    
    If Not CheckConnect Then
        GoTo ErrRtn
    End If
    
    If MsgID <> "" Then
        sSql = "UPDATE [BIZ_PURIO].[dbo].TBL_SMS_MSG SET title = '" & title & "', msg = '" & msg & "' WHERE SHOP_CODE = '" & 가맹점정보.가맹점코드 & "' AND MSG_ID = " & MsgID
    Else
        sSql = "INSERT INTO [BIZ_PURIO].[dbo].TBL_SMS_MSG(SHOP_CODE,TITLE, MSG, TYPE) VALUES ('" & 가맹점정보.가맹점코드 & "','" & title & "','" & msg & "','KAKAO')"
    End If
    
    SMSCon.Execute (sSql)
    SaveKaKaoMsg = True
    Exit Function
ErrRtn:
    SaveKaKaoMsg = False
End Function

Public Function DeleteKaKaoMsg(MsgID As String) As Boolean
On Error GoTo ErrRtn
    Dim sSql As String
    
    If Not CheckConnect Then
        GoTo ErrRtn
    End If
    
    If MsgID <> "" Then
        sSql = "DELETE [BIZ_PURIO].[dbo].TBL_SMS_MSG WHERE SHOP_CODE = '" & 가맹점정보.가맹점코드 & "' AND MSG_ID = " & MsgID
    End If
    
    SMSCon.Execute (sSql)
    DeleteKaKaoMsg = True
    Exit Function
ErrRtn:
    DeleteKaKaoMsg = False
End Function

Private Function CheckConnect() As Boolean
    On Error GoTo ErrRtn
    
    Dim HostConn    As String
    
    HostConn = ""
    HostConn = HostConn & "Provider=SQLOLEDB.1;"
    HostConn = HostConn & "Persist Security Info=False;"
    HostConn = HostConn & "User ID=" & m_SMS.UserID & ";"
    HostConn = HostConn & "Password=" & m_SMS.UserPW & ";"
    HostConn = HostConn & "Initial Catalog=" & m_SMS.DBName & ";"
    HostConn = HostConn & "Data Source=" & m_SMS.ServerIP
    m_CommandTimeOut = IIf(m_SMS.timeout = 0, 30, m_SMS.timeout)

    Set SMSCon = Nothing
    Set SMSCon = New ADODB.Connection
    
    If SMSCon.State = adStateOpen Then SMSCon.Close
    
    SMSCon.ConnectionTimeout = 10
    SMSCon.CommandTimeout = m_CommandTimeOut
    SMSCon.Open HostConn
    
    CheckConnect = True
    
    On Error GoTo 0
    
    Exit Function

ErrRtn:
    MsgBox "Error " & Err.Number & " (" & Err.description & ") in procedure CheckConnect of Module basBizPurio"
End Function



