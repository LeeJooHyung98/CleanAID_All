Attribute VB_Name = "basDBUpdate"
Option Explicit

Public Function SetDataBaseTable() As Boolean
    Dim Cnt     As Integer
    
    On Error GoTo dbError
    
    SetDataBaseTable = False
    
    Cnt = 0
    
RE_CHECK:
    Query = "SELECT * FROM TB_DataBaseUpdate "
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
    
    SetDataBaseTable = True
    
    ADORs.Close
    Set ADORs = Nothing
    
    Exit Function
    
dbError:
    ' 테이블이 없을 경우
    If Err.Number = 3078 And Cnt < 3 Then
        Query = "CREATE TABLE TB_DataBaseUpdate"
        Query = Query & " (idx INT NOT NULL"
        Query = Query & ", 작업일자  VARCHAR(20) NOT NULL)"
        ADOCon.Execute Query
        
        Cnt = Cnt + 1
        
        GoSub RE_CHECK
    End If
End Function

'----------------------------------------------------
' DB가 기존 DB일 경우 필드를 추가한다.
' bMode = true  : 전체를 무조건 실행한다.
' bMode = false : 업그레이드가 안된 내용만 실행한다.
'----------------------------------------------------
Public Sub Database_Check(bProcMode As Boolean)
    Dim bMode    As Boolean
    
    On Error GoTo ErrRtn
    
    If SetDataBaseTable = False Then Exit Sub
    
    For i = 0 To 0 ' 업데이트 갯수
        ' 업그레이드 안된 경우에 실행한다.
        If bProcMode = False Then
            Query = "SELECT idx FROM TB_DataBaseUpdate "
            Query = Query & " WHERE idx = " & i
            Set ADORs = New ADODB.Recordset
            ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
            
            If ADORs.EOF Then
                ADORs.Close
                Set ADORs = Nothing
                
                If Set_TableEdit(i) = True Then
                    bMode = True
                End If
            Else
                ADORs.Close
                Set ADORs = Nothing
            End If
        
        Else
            ' 무조건 실행한다. (조회 ->DB 관리에서 실행)
            
            If Set_TableEdit(i) Then
                bMode = True
            End If
        End If
    Next i
    
    If bMode Then
        bMsgMode = True
        strMessage = "데이터베이스를 수정하였습니다."
    End If
    
    Exit Sub
    
ErrRtn:
    Call Error_Msg("Database_Check", Err.Source, Err.Number, Err.Description)
End Sub

Private Function Set_TableEdit(iCount As Long) As Boolean
    On Error Resume Next
    
    Set_TableEdit = False
    
    Select Case iCount
        Case 1
            'TB_의류
'            Query = "ALTER TABLE TB_의류 ADD 본사전송여부 VARCHAR(1) DEFAULT ''"
'            ADOCon.Execute Query
'            DoEvents
'
'            Query = "UPDATE TB_의류 SET 본사전송여부 = ''"
'            ADOCon.Execute Query
'            DoEvents
'
'            'TB_의류분류
'            Query = "ALTER TABLE TB_의류분류 ADD 본사전송여부 VARCHAR(1) DEFAULT ''"
'            ADOCon.Execute Query
'            DoEvents
'
'            Query = "UPDATE TB_의류분류 SET 본사전송여부 = ''"
'            ADOCon.Execute Query
'            DoEvents
            
            GoSub SUB_OK
        
        Case 2
'            '--------------------------------------------------------
'            '목요세일
'            '--------------------------------------------------------
'            Query = "ALTER TABLE [CleanAID].[dbo].[TB_기본정보]"
'            Query = Query & " DROP Constraint DF_TB_기본정보_목요세일"
'            ADOCon.Execute Query
'
'            Query = "ALTER TABLE [CleanAID].[dbo].[TB_기본정보]"
'            Query = Query & " DROP COLUMN [목요세일]"
'            ADOCon.Execute Query
'
'            '--------------------------------------------------------
'            '금요세일
'            '--------------------------------------------------------
'            Query = "ALTER TABLE [CleanAID].[dbo].[TB_기본정보]"
'            Query = Query & " DROP Constraint DF_TB_기본정보_금요세일"
'            ADOCon.Execute Query
'
'            Query = "ALTER TABLE [CleanAID].[dbo].[TB_기본정보]"
'            Query = Query & " DROP COLUMN [금요세일]"
'            ADOCon.Execute Query
'
'            '요일할인
'            Query = "ALTER TABLE [CleanAID].[dbo].[TB_기본정보]"
'            Query = Query & " ADD [요일할인] VARCHAR(7) DEFAULT '0000000'"
'            ADOCon.Execute Query
            
            GoSub SUB_OK
        
    End Select
    
    Set_TableEdit = True
    
    Exit Function
    
SUB_OK:
        
    Query = "SELECT * FROM TB_DataBaseUpdate"
    Query = Query & " WHERE idx = " & iCount
    Set Rs = New ADODB.Recordset
    Rs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
    
    If Rs.EOF Then Rs.AddNew
    
    Rs!idx = iCount                          '
    Rs!작업일자 = Format(Now, "YYYY-MM-DD hh:mm:ss") '
    
    Rs.Update
    
    Rs.Close
    Set Rs = Nothing
    
    Return
End Function

'--------------------------------------------------------------------------
' 함수명 : ServerData_Receive
'
'
'--------------------------------------------------------------------------
Public Sub ServerData_Receive()
    Dim 적용일자    As String
    Dim RecordCount As Long
    
    On Error GoTo ErrRtn

    frmSplash.lblMsg.Caption = "잠시만 기다려 주세요..."
    frmSplash.ProgressBar1.Visible = True
    DoEvents
    
    If Get_가맹점정보 = "Error" Then
        MsgBox "가맹점 정보가 올바르지 않습니다. 확인후 저장하여 주십시요.", vbInformation, "확인"
        
        frm환경설정.Show 1
        End
    End If
    
    If Trim(가맹점정보.가맹점코드) = "" Then
        MsgBox "가맹점 정보가 올바르지 않습니다.", vbCritical, "경고"
        Exit Sub
    End If
    
    If Server_Connection(HostCon, "Laundry1000") = False Then Exit Sub
    
'-------------------------------------------------------------------
' TB_가맹점
'-------------------------------------------------------------------
    Query = "SELECT * FROM TB_가맹점"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
    
    If Not ADORs.EOF Then
        Query = "UPDATE TB_기본정보 SET"
        Query = Query & "  지사코드       = '" & Trim(ADORs!지사코드) & "'"
        Query = Query & ", 가맹점명       = '" & Trim(ADORs!가맹점명) & "'"
        Query = Query & ", 업태           = '" & Trim(ADORs!업태) & "'"
        Query = Query & ", 종목           = '" & Trim(ADORs!종목) & "'"
        Query = Query & ", 우편번호       = '" & Trim(ADORs!우편번호) & "'"
        Query = Query & ", 주소           = '" & Trim(ADORs!주소) & "'"
        Query = Query & ", 적용일자       = '" & Trim(ADORs!적용일자) & "'"
        Query = Query & ", 택코드         = '" & Trim(ADORs!택코드) & "'"
        Query = Query & ", 택색상         = '" & Trim(ADORs!택색상) & "'"
        
        If Len(ADORs!요일할인) < 7 Then
            Query = Query & ", 요일할인       = '0000000'"
        Else
            Query = Query & ", 요일할인       = '" & Trim(ADORs!요일할인) & "'"
        End If
        
        If Len(ADORs!세트상품세일) < 7 Then
            Query = Query & ", 세트상품세일   = '0000000'"
        Else
            Query = Query & ", 세트상품세일   = '" & Trim(ADORs!세트상품세일) & "'"
        End If
        
        Query = Query & ", 세탁소요일     = '" & Trim(ADORs!세탁소요일) & "'"
        Query = Query & ", 매장전화번호   = '" & Trim(ADORs!매장전화번호) & "'"
        Query = Query & ", 문자발신전화   = '" & Trim(ADORs!문자발신전화) & "'"
        Query = Query & ", 휴대전화번호   = '" & Trim(ADORs!휴대전화번호) & "'"
        Query = Query & ", SMS_IP         = '" & Trim(ADORs!SMS_IP) & "'"
        Query = Query & ", SMS_DB         = '" & Trim(ADORs!SMS_DB) & "'"
        Query = Query & ", SMS_ID         = '" & Trim(ADORs!SMS_ID) & "'"
        Query = Query & ", SMS_PWD        = '" & Trim(ADORs!SMS_PWD) & "'"
        Query = Query & ", [TimeOut]      =  " & ADORs!timeout
        Query = Query & ", SMS_EMART      = '" & Trim(ADORs!SMS_EMART) & "'"
        Query = Query & ", 외주마진       = '" & Trim(ADORs!외주마진) & "'"
        Query = Query & ", 특정할인여부   = '" & Trim(ADORs!특정할인여부) & "'"
        Query = Query & ", 특정할인비율   = '" & Trim(ADORs!특정할인비율) & "'"
        Query = Query & ", 특정할인시작일 = '" & Trim(ADORs!특정할인시작일) & "'"
        Query = Query & ", 특정할인종료일 = '" & Trim(ADORs!특정할인종료일) & "'"
        Query = Query & ", 쿠폰할인여부   = '" & Trim(ADORs!쿠폰할인여부) & "'"
        Query = Query & ", 쿠폰할인비율   = '" & Trim(ADORs!쿠폰할인비율) & "'"
        Query = Query & ", 쿠폰할인시작일 = '" & Trim(ADORs!쿠폰할인시작일) & "'"
        Query = Query & ", 쿠폰할인종료일 = '" & Trim(ADORs!쿠폰할인종료일) & "'"
        Query = Query & ", 지정할인여부   = '" & Trim(ADORs!지정할인여부) & "'"
        Query = Query & ", 지정할인비율   = '" & Trim(ADORs!지정할인비율) & "'"
        Query = Query & ", 지정할인시작일 = '" & Trim(ADORs!지정할인시작일) & "'"
        Query = Query & ", 지정할인종료일 = '" & Trim(ADORs!지정할인종료일) & "'"
        Query = Query & ", 고가세탁비율   = '" & Trim(ADORs!고가세탁비율) & "'"
        Query = Query & ", 세탁환불여부   = '" & Trim(ADORs!세탁환불여부) & "'"
        Query = Query & ", 마일리지여부   = '" & Trim(ADORs!마일리지여부) & "'"
        Query = Query & ", 기준금액       =  " & ADORs!기준금액
        Query = Query & ", 적립마일리지   =  " & ADORs!적립마일리지
        Query = Query & ", 최소마일리지   =  " & ADORs!최소마일리지
        Query = Query & ", 가맹점구분     = '" & Trim(ADORs!가맹점구분) & "'"
        Query = Query & ", 담당자코드     = '" & Trim(ADORs!담당자코드) & "'"
        Query = Query & ", 기사코드       = '" & Trim(ADORs!기사코드) & "'"
        Query = Query & ", 계약일자       = '" & Trim(ADORs!계약일자) & "'"
        Query = Query & ", 해지일자       = '" & Trim(ADORs!해지일자) & "'"
        Query = Query & ", 이전가맹점코드 = '" & Trim(ADORs!이전가맹점코드) & "'"
        Query = Query & ", 가맹점상태     = '" & Trim(ADORs!가맹점상태) & "'"
        Query = Query & ", 본사수신일자   = '" & Format(Now, "YYYY-MM-DD hh:mm:ss") & "'"
        Query = Query & ", 본사전송여부   = 'N'"
        Query = Query & ", 본사전송일자   = ''"
        Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        ADOCon.Execute Query
    End If
    ADORs.Close
    Set ADORs = Nothing
    
    
'-------------------------------------------------------------------
' TB_의류분류 - 적용일자를 가져온다.
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "의류분류정보 수신중..."
    DoEvents
    
    Query = "SELECT TOP 1 적용일자 FROM TB_의류분류"
    Query = Query & " ORDER BY 적용일자 DESC"
    Set SUBRs = New ADODB.Recordset
    SUBRs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly

    If SUBRs.EOF Then
        적용일자 = ""
    Else
        적용일자 = SUBRs(0) & ""
    End If
    SUBRs.Close
    Set SUBRs = Nothing
        
'-------------------------------------------------------------------
' 0) TB_가맹점의류분류 - 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    Query = "SELECT    가맹점코드"
    Query = Query & ", 적용일자"
    Query = Query & ", 의류분류코드"
    Query = Query & ", 의류분류명"
    Query = Query & ", 세탁마진"
    Query = Query & ", 외주마진"
    Query = Query & ", 수선마진"
    Query = Query & ", 순서"
    Query = Query & " FROM TB_가맹점의류분류"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    
    If 적용일자 = "" Then
        Query = Query & "   AND 적용일자 = (SELECT MAX(적용일자) FROM TB_가맹점의류분류"
        Query = Query & "                   WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        Query = Query & "                     AND 적용일자  <= '" & Format(Date, "YYYY-MM-DD") & "'"
        Query = Query & "                  ) "
    Else
        Query = Query & "   AND 적용일자 = (SELECT MAX(적용일자) FROM TB_가맹점의류분류"
        Query = Query & "                   WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        Query = Query & "                     AND (적용일자  > '" & Format(적용일자, "YYYY-MM-DD") & "'"
        Query = Query & "                     AND  적용일자 <= '" & Format(Date, "YYYY-MM-DD") & "')"
        Query = Query & "                  ) "
    End If
    
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    If Not ADORs.EOF Then
        ADOCon.Execute "DELETE FROM TB_의류분류" '이전 자료 삭제
    End If
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_의류분류"
        Query = Query & " WHERE 의류분류코드 = '" & ADORs!의류분류코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!의류분류코드 = ADORs!의류분류코드 & ""        ' 1 의류분류코드
        SUBRs!의류분류명 = Trim(ADORs!의류분류명) & ""      ' 2 의류분류명
        SUBRs!세탁마진 = ADORs!세탁마진 & ""                ' 3 세탁마진
        SUBRs!외주마진 = ADORs!외주마진 & ""                ' 4 외주마진
        SUBRs!수선마진 = ADORs!수선마진 & ""                ' 5 수선마진
        SUBRs!순서 = ADORs!순서 & ""                        ' 6 순서
        SUBRs!적용일자 = ADORs!적용일자 & ""                ' 7 적용일자
        SUBRs!수신일자 = Format(Now, "YYYY-MM-DD hh:mm:ss") ' 8 수신일자
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
    
    
'-------------------------------------------------------------------
' TB_의류 - 적용일자를 가져온다.
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "의류정보 수신중..."
    DoEvents
    
    Query = "SELECT TOP 1 적용일자 FROM TB_의류"
    Query = Query & " ORDER BY 적용일자 DESC"
    Set SUBRs = New ADODB.Recordset
    SUBRs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly

    If SUBRs.EOF Then
        적용일자 = ""
    Else
        적용일자 = SUBRs(0) & ""
    End If
    SUBRs.Close
    Set SUBRs = Nothing
        
'-------------------------------------------------------------------
' 1) TB_가맹점의류 - 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    Query = "SELECT    가맹점코드"
    Query = Query & ", 적용일자"
    Query = Query & ", 의류코드"
    Query = Query & ", 의류명"
    Query = Query & ", 금액"
    Query = Query & ", 순서"
    Query = Query & " FROM TB_가맹점의류"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    Query = Query & "   AND 사용여부   = 'Y'"
    
    If 적용일자 = "" Then
        Query = Query & "   AND 적용일자 = (SELECT MAX(적용일자) FROM TB_가맹점의류"
        Query = Query & "                   WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        Query = Query & "                     AND 적용일자  <= '" & Format(Date, "YYYY-MM-DD") & "'"
        Query = Query & "                  ) "
    Else
        Query = Query & "   AND 적용일자 = (SELECT MAX(적용일자) FROM TB_가맹점의류"
        Query = Query & "                   WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        Query = Query & "                     AND (적용일자  > '" & Format(적용일자, "YYYY-MM-DD") & "'"
        Query = Query & "                     AND  적용일자 <= '" & Format(Date, "YYYY-MM-DD") & "')"
        Query = Query & "                  ) "
    End If
    
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    If Not ADORs.EOF Then
        ADOCon.Execute "DELETE FROM TB_의류" '이전 자료 삭제
    End If
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_의류"
        Query = Query & " WHERE 의류코드 = '" & ADORs!의류코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!의류코드 = ADORs!의류코드 & ""                ' 1 의류코드
        SUBRs!의류명 = Trim(ADORs!의류명) & ""              ' 2 의류명
        SUBRs!금액 = ADORs!금액 & ""                        ' 3 금액
        SUBRs!순서 = ADORs!순서 & ""                        ' 4 순서
        SUBRs!적용일자 = ADORs!적용일자 & ""                ' 5 적용일자
        SUBRs!수신일자 = Format(Now, "YYYY-MM-DD hh:mm:ss") ' 6 수신일자
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
        
        
'-------------------------------------------------------------------
' 2) TB_가맹점입금 - 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "가맹점 입금 정보 수신중..."
    DoEvents
    
    Query = "SELECT * FROM TB_가맹점입금"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    Query = Query & "   AND (입금확정 IS NULL OR 입금확정 = '')"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
    
    i = 0
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_가맹점입금"
        'Query = Query & " WHERE 입금코드 = " & ADORs!입금코드
        Query = Query & " WHERE 입금일자 = '" & ADORs!입금일자 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        'SUBRs!입금코드 = ADORs!입금코드 & ""     ' 1
        SUBRs!가맹점코드 = ADORs!가맹점코드 & "" ' 2
        SUBRs!입금일자 = ADORs!입금일자 & ""     ' 3
        SUBRs!배송기사명 = ADORs!배송기사명 & "" ' 4
        SUBRs!입금액 = ADORs!입금액 & ""         ' 5
        SUBRs!비고 = ADORs!비고 & ""             ' 6
        SUBRs!입금확정 = ADORs!입금확정 & ""     ' 7
        SUBRs!확정일자 = ADORs!확정일자 & ""     ' 8
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
        
    
'-------------------------------------------------------------------
' 3) TB_부자재주문- 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "부자재 주문 정보 수신중..."
    DoEvents
    
    Query = "SELECT * FROM TB_부자재주문"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    Query = Query & "   AND (출고일자 IS NOT NULL OR 출고일자 <> '')"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
    'ADORs.Open Query, HostCon, adOpenStatic, adLockOptimistic
    
    i = 0
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_부자재주문"
        Query = Query & " WHERE 주문코드 = " & ADORs!주문코드
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If Not SUBRs.EOF Then
            SUBRs!출고일자 = ADORs!출고일자 & ""     ' 1
            
            SUBRs.Update
        End If
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
        
        
'-------------------------------------------------------------------
' 4) TB_세트상품 - 시작일자를 가져온다.
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "세트상품 수신중..."
    DoEvents
    
    Query = "SELECT TOP 1 시작일자 FROM TB_세트상품"
    Query = Query & " ORDER BY 시작일자 DESC"
    Set SUBRs = New ADODB.Recordset
    SUBRs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly

    If SUBRs.EOF Then
        적용일자 = ""
    Else
        적용일자 = SUBRs(0) & ""
    End If
    SUBRs.Close
    Set SUBRs = Nothing
        
    '-------------------------------------------------------------------
    ' TB_세트상품 - 크린에이드 서버에서 수신
    '-------------------------------------------------------------------
    Query = "SELECT    시작일자"
    Query = Query & ", 종료일자"
    Query = Query & ", SET2_1"
    Query = Query & ", SET2_2"
    Query = Query & " FROM TB_세트상품"
    
    If 적용일자 = "" Then
        Query = Query & " WHERE 시작일자 = (SELECT MAX(시작일자) FROM TB_세트상품"
        Query = Query & "                   WHERE 시작일자  <= '" & Format(Date, "YYYY-MM-DD") & "'"
        Query = Query & "                  ) "
    Else
        Query = Query & " WHERE 시작일자 = (SELECT MAX(시작일자) FROM TB_세트상품"
        Query = Query & "                   WHERE (시작일자  > '" & Format(적용일자, "YYYY-MM-DD") & "'"
        Query = Query & "                     AND  시작일자 <= '" & Format(Date, "YYYY-MM-DD") & "')"
        Query = Query & "                  ) "
    End If
    
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_세트상품"
        Query = Query & " WHERE 시작일자 = '" & ADORs!시작일자 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!시작일자 = Format(ADORs!시작일자, "YYYY-MM-DD") & "" ' 1 시작일자
        SUBRs!종료일자 = Format(ADORs!종료일자, "YYYY-MM-DD") & "" ' 2 종료일자
        SUBRs!SET2_1 = ADORs!SET2_1 & ""                           ' 3 세트2_1
        SUBRs!SET2_2 = ADORs!SET2_2 & ""                           ' 4 세트2_2
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
                    
                    
'-------------------------------------------------------------------
' 5) TB_요일할인 - 시작일자를 가져온다.
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "요일할인 수신중..."
    DoEvents
    
    '-------------------------------------------------------------------
    ' TB_가맹점요일할인 - 크린에이드 서버에서 수신
    '-------------------------------------------------------------------
    Query = "SELECT    시작일자"
    Query = Query & ", 종료일자"
    Query = Query & ", 요일"
    Query = Query & ", 의류코드"
    Query = Query & ", 의류명"
    Query = Query & ", 금액"
    Query = Query & ", 할인금액"
    Query = Query & ", 할인율"
    Query = Query & " FROM TB_가맹점요일할인"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    Query = Query & "   AND (수신여부 IS NULL OR 수신여부 = '')"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_요일할인"
        Query = Query & " WHERE 시작일자 = '" & ADORs!시작일자 & "'"
        Query = Query & "   AND 요일     = '" & ADORs!요일 & "'"
        Query = Query & "   AND 의류코드 = '" & ADORs!의류코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!시작일자 = Format(ADORs!시작일자, "YYYY-MM-DD") & "" ' 1 시작일자
        SUBRs!종료일자 = Format(ADORs!종료일자, "YYYY-MM-DD") & "" ' 2 종료일자
        SUBRs!요일 = ADORs!요일 & ""                               ' 3
        SUBRs!의류코드 = ADORs!의류코드 & ""                       ' 4
        SUBRs!의류명 = ADORs!의류명 & ""                           ' 5
        SUBRs!금액 = ADORs!금액 & ""                               ' 6
        SUBRs!할인금액 = ADORs!할인금액 & ""                       ' 7
        SUBRs!할인율 = ADORs!할인율 & ""                           ' 8
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        '---------------------------------------------------------------------------------------------
        ' 서버 - 수신여부
        '---------------------------------------------------------------------------------------------
        Query = "UPDATE TB_가맹점요일할인 SET 수신여부 = 'Y'"
        Query = Query & "                   , 수신일자 = '" & Format(Now, "YYYY-MM-DD hh:mm:ss") & "'"
        Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        Query = Query & "   AND 시작일자   = '" & ADORs!시작일자 & "'"
        Query = Query & "   AND 요일       = '" & ADORs!요일 & "'"
        Query = Query & "   AND 의류코드   = '" & ADORs!의류코드 & "'"
        HostCon.Execute Query
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
                    
                    
'-------------------------------------------------------------------
' 6) TB_할인 - 시작일자를 가져온다.
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "할인정보 수신중..."
    DoEvents
    
    '-------------------------------------------------------------------
    ' TB_가맹점할인 - 크린에이드 서버에서 수신
    '-------------------------------------------------------------------
    Query = "SELECT    시작일자"
    Query = Query & ", 종료일자"
    Query = Query & ", 의류코드"
    Query = Query & ", 의류명"
    Query = Query & ", 금액"
    Query = Query & ", 할인금액"
    Query = Query & ", 할인율"
    Query = Query & " FROM TB_가맹점할인"
    Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
    Query = Query & "   AND (수신여부 IS NULL OR 수신여부 = '')"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_할인정보"
        Query = Query & " WHERE 시작일자 = '" & ADORs!시작일자 & "'"
        Query = Query & "   AND 의류코드 = '" & ADORs!의류코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!시작일자 = Format(ADORs!시작일자, "YYYY-MM-DD") & "" ' 1 시작일자
        SUBRs!종료일자 = Format(ADORs!종료일자, "YYYY-MM-DD") & "" ' 2 종료일자
        SUBRs!의류코드 = ADORs!의류코드 & ""                       ' 4
        SUBRs!의류명 = ADORs!의류명 & ""                           ' 5
        SUBRs!금액 = ADORs!금액 & ""                               ' 6
        SUBRs!할인금액 = ADORs!할인금액 & ""                       ' 7
        SUBRs!할인율 = ADORs!할인율 & ""                           ' 8
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        '---------------------------------------------------------------------------------------------
        ' 서버 - 수신여부
        '---------------------------------------------------------------------------------------------
        Query = "UPDATE TB_가맹점할인 SET 수신여부 = 'Y'"
        Query = Query & "               , 수신일자 = '" & Format(Now, "YYYY-MM-DD hh:mm:ss") & "'"
        Query = Query & " WHERE 가맹점코드 = '" & 가맹점정보.가맹점코드 & "'"
        Query = Query & "   AND 시작일자   = '" & ADORs!시작일자 & "'"
        Query = Query & "   AND 의류코드   = '" & ADORs!의류코드 & "'"
        HostCon.Execute Query
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
                    
                    
'-------------------------------------------------------------------
' 7) TB_고객등급 - 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "고객등급 수신중..."
    DoEvents
    
    Query = "SELECT    고객등급코드"
    Query = Query & ", 고객등급명"
    Query = Query & ", 순서"
    Query = Query & " FROM TB_고객등급"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    If Not ADORs.EOF Then
        ADOCon.Execute "DELETE FROM TB_고객등급" '이전 자료 삭제
    End If
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_고객등급"
        Query = Query & " WHERE 고객등급코드 = '" & ADORs!고객등급코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!고객등급코드 = ADORs!고객등급코드 & ""        ' 1 고객등급코드
        SUBRs!고객등급명 = Trim(ADORs!고객등급명) & ""      ' 2 고객등급명
        SUBRs!순서 = ADORs!순서 & ""                        ' 4 순서
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
                    
                    
'-------------------------------------------------------------------
' 8) TB_미입고사유 - 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "미입고사유 수신중..."
    DoEvents

    Query = "SELECT    미입고사유코드"
    Query = Query & ", 미입고사유"
    Query = Query & ", 순서"
    Query = Query & " FROM TB_미입고사유"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    If Not ADORs.EOF Then
        ADOCon.Execute "DELETE FROM TB_미입고사유" '이전 자료 삭제
    End If
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_미입고사유"
        Query = Query & " WHERE 미입고사유코드 = '" & ADORs!미입고사유코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!미입고사유코드 = ADORs!미입고사유코드 & ""    ' 1 미입고사유코드
        SUBRs!미입고사유 = Trim(ADORs!미입고사유) & ""      ' 2 미입고사유
        SUBRs!순서 = ADORs!순서 & ""                        ' 4 순서
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
                    
                    
'-------------------------------------------------------------------
' 9) TB_환불사유 - 크린에이드 서버에서 수신
'-------------------------------------------------------------------
    frmSplash.lblMsg.Caption = "환불사유 수신중..."
    DoEvents

    Query = "SELECT    환불사유코드"
    Query = Query & ", 환불사유"
    Query = Query & ", 순서"
    Query = Query & " FROM TB_환불사유"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, HostCon, adOpenForwardOnly, adLockReadOnly
        
    i = 0
    
    If Not ADORs.EOF Then
        ADOCon.Execute "DELETE FROM TB_환불사유" '이전 자료 삭제
    End If
    
    Do Until ADORs.EOF
        i = i + 1
        
        frmSplash.lblCount.Caption = i
        'frmSplash.ProgressBar1.Value = (i / RecordCount) * 100
        DoEvents
        
        '--------------------------------------------------------------
        ' TB_의류 - 의류금액 정보 다운로드
        '--------------------------------------------------------------
        Query = "SELECT * FROM TB_환불사유"
        Query = Query & " WHERE 환불사유코드 = '" & ADORs!환불사유코드 & "'"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic
        
        If SUBRs.EOF Then SUBRs.AddNew
        
        SUBRs!환불사유코드 = ADORs!환불사유코드 & ""    ' 1 환불사유코드
        SUBRs!환불사유 = Trim(ADORs!환불사유) & ""      ' 2 환불사유
        SUBRs!순서 = ADORs!순서 & ""                        ' 4 순서
        
        SUBRs.Update
        
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
    
    HostCon.Close
    Set HostCon = Nothing

    'Call Set_고객최종거래일자 '2010-12-23 까지 임시로 실행
    Call Set_세탁마진          '2010-12-28 까지 임시로 실행
    Call Set_일일마감          '2010-12-31 까지 임시로 실행

    frmSplash.lblCount.Caption = "0"
    frmSplash.lblMsg.Caption = "잠시만 기다려 주세요..."
    DoEvents

    Exit Sub

ErrRtn:
    Call Error_Msg("ServerData_Receive", Err.Source, Err.Number, Err.Description)
End Sub

'--------------------------------------------------
' 고객정보 변환 - 최종거래일자 변환 오류
' 2010-12-23 까지 임시로 실행
'--------------------------------------------------
Private Sub Set_고객최종거래일자()
    Dim MDBCon  As ADODB.Connection
    
    On Error GoTo ErrRtn
    
    Set MDBCon = New ADODB.Connection

    With MDBCon
        .ConnectionString = "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=C:\Laundry\DB\LAUNDRY.MDB;Jet OLEDB:Database Password="
        .Open
    End With
    
    i = 0
    DoEvents
    
    '
    Query = "SELECT * FROM 마일리지현황"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, MDBCon, adOpenForwardOnly, adLockReadOnly

    Do Until ADORs.EOF
        i = i + 1
        DoEvents
        
        '---------------------------------------------------------
        ' TB_고객정보
        '---------------------------------------------------------
        Query = "SELECT * FROM TB_고객정보"
        Query = Query & " WHERE 고객코드 = '" & Trim(ADORs!고객번호) & "'"
        Query = Query & "   AND (최종거래일자 IS NULL OR 최종거래일자 = '')"
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenDynamic, adLockOptimistic

        If Not SUBRs.EOF Then
            SUBRs!최종거래일자 = Format(ADORs!최종거래일자, "0000-00-00") & " 00:00:00"
            
            SUBRs.Update
        End If
        SUBRs.Close
        Set SUBRs = Nothing
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
    
    MDBCon.Close
    Set MDBCon = Nothing
    
    '
    Query = "DELETE FROM TB_매출"
    Query = Query & " WHERE 매출일자 <= '2010-12-20'"
    Query = Query & "   AND 적요      = '[마일리지 삭제]'"
    ADOCon.Execute Query
    
    Exit Sub
    
ErrRtn:
    Call Error_Msg("", Err.Source, Err.Number, Err.Description)

    Screen.MousePointer = 0
End Sub

Private Sub Set_일일마감()
    Dim 마감일자   As String
    Dim 접수금액   As Long
    Dim 가맹점마진 As Long
    Dim 외주마진   As Long
    
    Dim 미수금액   As Long
    Dim tmpData    As String
    
    Dim strCancel  As String
    Dim strReturn  As String
    Dim strRepay   As String
    
    On Error GoTo ErrRtn
    
    Screen.MousePointer = 11
    
    Call Get_가맹점정보
    
    마감일자 = "2010-12-15"
    
    Do Until 마감일자 > "2010-12-24"
        Dim iNum(1 To 18)  As Long
        Dim iCost(1 To 27) As Long
        Dim strTag(0 To 1) As String
        
        '----------------------------------------------------------------
        ' 1. 접수수량, 접수금액 구하기
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(택번호),0)"
        Query = Query & ", ISNULL(SUM(금액),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(1) = ADORs(0)  '접수건수
        iCost(1) = ADORs(1) '접수금액
        
        ADORs.Close
        Set ADORs = Nothing
            
            
        '----------------------------------------------------------------
        ' 2. 출고수량 구하기
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(택번호),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 출고일자 = '" & 마감일자 & "'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        
        iNum(2) = Recordset_Result(Query) '출고수량
            
            
        '----------------------------------------------------------------
        ' 2-1) 현금결제 구하기
        '----------------------------------------------------------------
        '선불결제
        Query = "SELECT ISNULL(SUM(현금입금),0)"
        Query = Query & " FROM TB_매출"
        Query = Query & " WHERE 매출일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 접수금액 <> 0"
            
        iCost(2) = Recordset_Result(Query) '
        
        '----------------------------------------------------------------
        ' 미수입금
        '----------------------------------------------------------------
        Query = "SELECT ISNULL(SUM(현금입금),0)"
        Query = Query & " FROM TB_매출"
        Query = Query & " WHERE 매출일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 접수금액 = 0"
            
        iCost(5) = Recordset_Result(Query) '
        
        
        '----------------------------------------------------------------
        ' 2-2) 카드결제 구하기
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(카드입금),0)"
        Query = Query & ", ISNULL(SUM(카드입금),0)"
        Query = Query & " FROM TB_매출"
        Query = Query & " WHERE 매출일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 카드입금 > 0"
        Query = Query & "   AND 접수금액 <> 0"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(3) = ADORs(0)
        iCost(3) = ADORs(1)
            
        ADORs.Close
        Set ADORs = Nothing
    
        '----------------------------------------------------------------
        ' 2-2) 카드결제 구하기
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(카드입금),0)"
        Query = Query & ", ISNULL(SUM(카드입금),0)"
        Query = Query & " FROM TB_매출"
        Query = Query & " WHERE 매출일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 카드입금 > 0"
        Query = Query & "   AND 접수금액 = 0"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(4) = ADORs(0)
        iCost(6) = ADORs(1)
            
        ADORs.Close
        Set ADORs = Nothing
            
            
        iCost(7) = iCost(2) + iCost(5) '현금결제합계
        iNum(5) = iNum(3) + iNum(4)    '카드결제건수 합계
        iCost(8) = iCost(3) + iCost(6) '카드결제합계
            
        '----------------------------------------------------------------
        ' 3-1) 가맹점 마진
        '----------------------------------------------------------------
        Query = "SELECT ISNULL(SUM(금액 * 세탁마진/100),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        'Query = Query & "   AND SUBSTRING(의류코드,1,1) <> 'a'"                 '운동화
        'Query = Query & "   AND (내용 LIKE '%세%' OR 내용 LIKE '%건%'  OR 내용 LIKE '%습%')"
        Query = Query & "   AND 내용 NOT LIKE '%수%'"                            '수선 제외
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        
        iCost(9) = Recordset_Result(Query)
        
    
        '----------------------------------------------------------------
        ' 3-2) 외주 마진
        '----------------------------------------------------------------
        Query = "SELECT ISNULL(SUM(금액*외주마진/100),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND SUBSTRING(의류코드,1,1) = 'a'"                 '운동화
        'Query = Query & "   AND (내용 LIKE '%세%' OR 내용 LIKE '%건%'  OR 내용 LIKE '%습%')"
        Query = Query & "   AND 내용 NOT LIKE '%수%'"                            '수선 제외
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        
        iCost(17) = Recordset_Result(Query)
        
        'iCost(10) = iCost(1) - iCost(9) - iCost(17) ' 지사 마진 = 접수금액 - 가맹점마진 - 외주마진 '
        iCost(10) = iCost(1) - iCost(9)              ' 지사 마진 = 접수금액 - 가맹점마진
    
        '----------------------------------------------------------------
        ' 6) 판매취소 계산
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(택번호),0)"
        Query = Query & ", ISNULL(SUM(금액),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE SUBSTRING(판매취소일자,1,10) = '" & 마감일자 & "'"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(13) = ADORs(0)
        iCost(22) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
            
            
        '----------------------------------------------------------------
        ' 7) 반품환불 계산
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(택번호),0)"
        Query = Query & ", ISNULL(SUM(금액),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE SUBSTRING(반품환불일자,1,10) = '" & 마감일자 & "'"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(14) = ADORs(0)
        iCost(23) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
        
        '----------------------------------------------------------------
        ' 8) 세탁환불 계산
        '----------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(택번호),0)"
        Query = Query & ", ISNULL(SUM(금액),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE SUBSTRING(세탁환불일자,1,10) = '" & 마감일자 & "'"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(15) = ADORs(0)
        iCost(24) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
        
    '=================================================================================
        '--------------------------------------------------------------
        ' 9-1) 수선수량 계산
        '--------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(택번호),0)"
        Query = Query & ", ISNULL(SUM(수선금액),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND (내용  = '드수' OR 내용 = '수') "
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
    
        iNum(6) = ADORs(0)
        iCost(11) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
    
    
        '----------------------------------------------------------------
        ' 9-1) 재세탁수량 계산
        '----------------------------------------------------------------
        Query = "SELECT ISNULL(COUNT(택번호),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 내용     = '드재'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        
        iNum(7) = Recordset_Result(Query)
            
            
        '--------------------------------------------------------------------
        '운동화 매출을 불러온다.
        '--------------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(의류코드),0)" '운동화건수
        Query = Query & ", ISNULL(SUM(금액),0)"       '운동화금액
        Query = Query & " FROM TB_입출고 "
        Query = Query & " WHERE SUBSTRING(의류코드,1,2) = 'a0'"
        Query = Query & "   AND 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(8) = ADORs(0)
        iCost(13) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
    
        
        '--------------------------------------------------------------------
        '가죽/무스탕 매출을 불러온다.
        '--------------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(의류코드),0)" '가죽건수
        Query = Query & ", ISNULL(SUM(금액),0)"       '가죽금액
        Query = Query & " FROM TB_입출고 "
        Query = Query & " WHERE SUBSTRING(의류코드,1,2) IN ('b0','n0')"
        Query = Query & "   AND 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(9) = ADORs(0)
        iCost(14) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
        
        '--------------------------------------------------------------------
        '카페트 매출을 불러온다.
        '--------------------------------------------------------------------
        Query = "SELECT    ISNULL(COUNT(의류코드),0)" '카페트건수
        Query = Query & ", ISNULL(SUM(금액),0) "      '카페트금액
        Query = Query & " FROM TB_입출고 "
        Query = Query & " WHERE SUBSTRING(의류코드,1,2) = 'x0'"
        Query = Query & "   AND 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(10) = ADORs(0)
        iCost(15) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
            
            
        '----------------------------------------------------------------
        ' 반품수량
        '----------------------------------------------------------------
        Query = "SELECT ISNULL(COUNT(택번호),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 내용     = '%반%'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        
        iNum(11) = Recordset_Result(Query)
            
            
        '--------------------------------------------------------------------
        ' 발생/사용/삭제 마일리지
        '--------------------------------------------------------------------
        Query = "SELECT    ISNULL(SUM(발생마일리지),0)"
        Query = Query & ", ISNULL(SUM(사용마일리지),0)"
        Query = Query & ", ISNULL(SUM(삭제마일리지),0)"
        Query = Query & " FROM TB_매출"
        Query = Query & " WHERE 매출일자 = '" & 마감일자 & "'"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iCost(18) = ADORs(0) '
        iCost(19) = ADORs(1) '사용마일리지
        iCost(20) = ADORs(2) '
        
        iCost(27) = iCost(19) '사용마일리지
        
        ADORs.Close
        Set ADORs = Nothing
        
        '사용마일지가 있는 경우 지사:가맹점(6:4)로 빼준다.
        If iCost(19) > 0 Then
            iCost(9) = iCost(9) - (iCost(19) * 0.4) '가맹점
            iCost(10) = iCost(10) - (iCost(19) * 0.6) '지사
        End If
            
        '--------------------------------------------------------------------
        ' 쿠폰
        '--------------------------------------------------------------------
        Query = "SELECT    ISNULL(SUM(쿠폰입금),0)"
        Query = Query & ", ISNULL(COUNT(쿠폰번호),0)"
        Query = Query & " FROM TB_매출"
        Query = Query & " WHERE 매출일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 쿠폰입금 > 0"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        iNum(12) = ADORs(0)
        iCost(21) = ADORs(1)
        
        ADORs.Close
        Set ADORs = Nothing
            
'        '----------------------------------------------------------------
'        ' 6) 판매취소 계산
'        '----------------------------------------------------------------
'        Query = "SELECT    택번호"
'        Query = Query & " FROM TB_입출고"
'        Query = Query & " WHERE SUBSTRING(판매취소일자,1,10) = '" & 마감일자 & "'"
'        Query = Query & " ORDER BY 택번호 ASC"
'
'        Call Get_택번호(Query, cboCancel)
'
'
'        '----------------------------------------------------------------
'        ' 7) 반품환불 계산
'        '----------------------------------------------------------------
'        Query = "SELECT    택번호"
'        Query = Query & " FROM TB_입출고"
'        Query = Query & " WHERE SUBSTRING(반품환불일자,1,10) = '" & 마감일자 & "'"
'
'        Call Get_택번호(Query, cboReturn)
'
'
'        '----------------------------------------------------------------
'        ' 8) 세탁환불 계산
'        '----------------------------------------------------------------
'        Query = "SELECT    택번호"
'        Query = Query & " FROM TB_입출고"
'        Query = Query & " WHERE SUBSTRING(세탁환불일자,1,10) = '" & 마감일자 & "'"
'
'        Call Get_택번호(Query, cboRepay)
    
    
        '--------------------------------------------------------------------
        ' 누락TAG CHECK
        '--------------------------------------------------------------------
        Dim 시작택번호   As String
        Dim 마지막택번호 As String
        
        Dim 택번호 As String
        Dim tmpTAG As String
        
        Query = "SELECT    MIN(택번호)"
        Query = Query & ", MAX(택번호)"
        Query = Query & " FROM TB_입출고 "
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        If Not ADORs.EOF Then
            시작택번호 = ADORs(0) & ""
            마지막택번호 = ADORs(1) & ""
        End If
        ADORs.Close
        Set ADORs = Nothing
            
'        '--------------------------------------------------------------------
'        ' 누락택
'        '--------------------------------------------------------------------
'        cboMissTag.Clear
'
'        Dim iLoop As Long
'
'        Query = "SELECT 택번호 FROM TB_입출고"
'        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
'        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
'        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
'        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
'
'        Query = Query & " ORDER BY 택번호 ASC"
'        Set ADORs = New ADODB.Recordset
'        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
'
'        iLoop = 0
'
'        택번호 = ""
'        tmpTAG = ""
'
'        If Val(마지막택번호) - Val(시작택번호) < 5000 Then
'            Do Until ADORs.EOF
'                If tmpTAG = "" Then
'                    tmpTAG = ADORs!택번호
'                Else
'                    Do Until Format(CLng(tmpTAG) + 1, "000000000") >= ADORs!택번호
'                        cboMissTag.AddItem Format(CLng(tmpTAG) + 1, "000-00-0000")
'
'                        tmpTAG = Format(CLng(tmpTAG) + 1, "000000000")
'
'                        '100 개가 넘으면 빠져 나옴
'                        If iLoop >= 100 Then
'                            cboMissTag.AddItem "Err"
'
'                            Exit Do
'                        End If
'
'                        iLoop = iLoop + 1
'                    Loop
'
'                    tmpTAG = Format(CLng(tmpTAG) + 1, "000000000")
'                End If
'
'                ADORs.MoveNext
'            Loop
'            ADORs.Close
'            Set ADORs = Nothing
'
'            If cboMissTag.ListCount = 0 Then
'                iNum(16) = 0
'            Else
'                iNum(16) = cboMissTag.ListCount - 1
'            End If
'        End If
        
        strTag(0) = Format(시작택번호, "000-00-0000") & ""
        strTag(1) = Format(마지막택번호, "000-00-0000") & ""
    
        '--------------------------------------------------------------------
        ' 삼성 카드 할인 내용 추가
        '--------------------------------------------------------------------
        Dim 삼성카드고객수   As Long
        Dim 삼성카드할인건수 As Long
        Dim 삼성카드할인금액 As Long
    
        삼성카드고객수 = 0
        삼성카드할인건수 = 0
        삼성카드할인금액 = 0
        
        Query = "SELECT    고객코드"
        Query = Query & ", ISNULL(COUNT(금액),0)"
        Query = Query & ", ISNULL(SUM(금액),0)"
        Query = Query & " FROM TB_입출고"
        Query = Query & " WHERE 접수일자 = '" & 마감일자 & "'"
        Query = Query & "   AND 내용  LIKE '%삼%'"
        Query = Query & "   AND ((판매취소 = '') AND (판매취소일자 IS NULL OR 판매취소일자 = '')"
        Query = Query & "   AND (반품환불일자 IS NULL OR 반품환불일자 = '')"
        Query = Query & "   AND (세탁환불일자 IS NULL OR 세탁환불일자 = ''))"
        Query = Query & " GROUP BY 고객코드"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        Do Until ADORs.EOF
            삼성카드고객수 = 삼성카드고객수 + 1
    
            삼성카드할인건수 = 삼성카드할인건수 + ADORs(0)
            삼성카드할인금액 = 삼성카드할인금액 + ADORs(1)
            
            ADORs.MoveNext
        Loop
        ADORs.Close
        Set ADORs = Nothing
        
        iCost(26) = 삼성카드할인금액
        iNum(17) = 삼성카드할인건수
        iNum(18) = 삼성카드고객수
                
        '미수금액 = 매출액 - 현금결제 - 카드결제 - 사용마일리지 - 쿠폰
        iCost(4) = iCost(1) - iCost(2) - iCost(3) - iCost(19) - iCost(21)
            
        '-----------------------------------------------------------
        ' TB_일일마감
        '-----------------------------------------------------------
        Query = "DELETE FROM TB_일일마감 WHERE 마감일자 = '" & 마감일자 & "'"
        ADOCon.Execute Query
        
'*****************************************************************************
        Dim chkWeekDay As Integer
        Dim chkSale    As String
        
        '-----------------------------------------------------------
        ' TB_할인정보
        '-----------------------------------------------------------
        Query = "SELECT * FROM TB_할인정보"
        Query = Query & " WHERE 시작일자 <= '" & 마감일자 & "' "
        Query = Query & "   AND 종료일자 >= '" & 마감일자 & "' "
        Set SUBRs = New ADODB.Recordset
        SUBRs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
        
        If Not SUBRs.EOF Then
            SUBRs.Close
            Set SUBRs = Nothing
            
            chkSale = "1"       ' 기간할인
            
            Exit Sub
        End If
        SUBRs.Close
        Set SUBRs = Nothing
    
        '-----------------------------------------------------------
        ' TB_기본정보
        '-----------------------------------------------------------
        Query = "SELECT 요일할인 FROM TB_기본정보"
        Set ADORs = New ADODB.Recordset
        ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly
    
        If Not ADORs.EOF Then
            i = Weekday(Date)
            
            If Mid(ADORs(0), i, 1) = "1" Then
                chkSale = "2"      ' 요일할인
            Else
                chkSale = "3"      ' 정상
            End If
        End If
        ADORs.Close
        Set ADORs = Nothing
        
'*****************************************************************************

        '--------------------------------------------------------------------
        '
        '--------------------------------------------------------------------
        Query = "INSERT INTO TB_일일마감("
        Query = Query & "  가맹점코드"         ' 1
        Query = Query & ", 마감일자"           ' 2
        Query = Query & ", 접수금액"           ' 3
        Query = Query & ", 접수수량"           ' 4
        Query = Query & ", 출고수량"           ' 5
        Query = Query & ", 반품수량"           ' 6
        Query = Query & ", 재세탁수량"         ' 7
        Query = Query & ", 수선금액"           ' 8
        Query = Query & ", 수선수량"           ' 9
        Query = Query & ", 판매구분"           '10
        Query = Query & ", 시작택번호"         '11
        Query = Query & ", 종료택번호"         '12
        Query = Query & ", 쿠폰금액"           '13
        Query = Query & ", 쿠폰건수"           '14
        Query = Query & ", 발생마일리지"       '15
        Query = Query & ", 사용마일리지"       '16
        Query = Query & ", 삭제마일리지"       '17
        Query = Query & ", 현금입금"           '18
        Query = Query & ", 카드금액"           '19
        Query = Query & ", 카드건수"           '20
        Query = Query & ", 반품환불금액"       '21
        Query = Query & ", 반품환불건수"       '22
        Query = Query & ", 세탁환불금액"       '23
        Query = Query & ", 세탁환불건수"       '24
        Query = Query & ", 삼성카드할인금액"   '25
        Query = Query & ", 삼성카드할인건수"   '26
        Query = Query & ", 삼성카드할인고객수" '27
        Query = Query & ", 근무자명"           '28
        Query = Query & ", 지사금액"           '29
        Query = Query & ", 가맹점금액"         '30
        Query = Query & ", 운동화금액"         '31
        Query = Query & ", 운동화건수"         '32
        Query = Query & ", 운동화비율"         '33
        Query = Query & ", 카페트금액"         '34
        Query = Query & ", 카페트건수"         '35
        Query = Query & ", 명품세탁금액"       '36
        Query = Query & ", 명품세탁건수"       '37
        Query = Query & ", 명품세탁비율"       '38
        Query = Query & ", 명품염색금액"       '39
        Query = Query & ", 명품염색건수"       '40
        Query = Query & ", 명품염색비율"       '41
        Query = Query & ", 마감여부"           '42
        Query = Query & ", 본사전송여부"       '43
        Query = Query & ", 지사코드"           '44
        Query = Query & ") VALUES ("
        Query = Query & "   '" & 가맹점정보.가맹점코드 & "'"       ' 1 가맹점코드
        Query = Query & ",  '" & 마감일자 & "'"                    ' 2 마감일자
        Query = Query & ",  " & iCost(1)                           ' 3 접수금액
        Query = Query & ",  " & iNum(1)                            ' 4 접수수량
        Query = Query & ",  " & iNum(2)                            ' 5 출고수량
        Query = Query & ",  " & iNum(11)                           ' 6 반품수량
        Query = Query & ",  " & iNum(7)                            ' 7 재세탁수량
        Query = Query & ",  " & iCost(11)                          ' 8 수선금액
        Query = Query & ",  " & iNum(6)                            ' 9 수선수량
        Query = Query & ", '" & chkSale & "'"                      '10 판매구분
        Query = Query & ", '" & Replace(strTag(0), "-", "") & "'"  '11 시작택번호
        Query = Query & ", '" & Replace(strTag(1), "-", "") & "'"  '12 종료택번호
        Query = Query & ",  " & iCost(21)                          '13 쿠폰금액
        Query = Query & ",  " & iNum(12)                           '14 쿠폰건수
        Query = Query & ",  " & iCost(18)                          '15 발생마일리지
        Query = Query & ",  " & iCost(19)                          '16 사용마일리지
        Query = Query & ",  " & iCost(20)                          '17 삭제마일리지
        Query = Query & ",  " & iCost(2)                           '18 현금입금
        Query = Query & ",  " & iCost(3)                           '19 카드금액
        Query = Query & ",  " & iNum(3)                            '20 카드건수
        Query = Query & ",  " & iCost(23)                          '21 반품환불금액
        Query = Query & ",  " & iNum(14)                           '22 반품환불건수
        Query = Query & ",  " & iCost(24)                          '23 세탁환불금액
        Query = Query & ",  " & iNum(15)                           '24 세탁환불건수
        Query = Query & ",  " & iCost(26)                          '25 삼성카드할인금액
        Query = Query & ",  " & iNum(17)                           '26 삼성카드할인건수
        Query = Query & ",  " & iNum(18)                           '27 삼성카드할인고객수
        Query = Query & ", '근무자'"                               '28 근무자명
        Query = Query & ",  " & iCost(10)                          '29 지사금액
        Query = Query & ",  " & iCost(9)                           '30 가맹점금액
        Query = Query & ",  " & iCost(13)                          '31 운동화금액
        Query = Query & ",  " & iNum(8)                            '32 운동화건수
        Query = Query & ",  0"                                     '33 운동화비율
        Query = Query & ",  " & iCost(15)                          '34 카페트금액
        Query = Query & ",  " & iNum(10)                           '35 카페트건수
        Query = Query & ",  0"                                     '36 명품세탁금액
        Query = Query & ",  0"                                     '37 명품세탁건수
        Query = Query & ",  0"                                     '38 명품세탁비율
        Query = Query & ",  0"                                     '39 명품염색금액
        Query = Query & ",  0"                                     '40 명품염색건수
        Query = Query & ",  0"                                     '41 명품염색비율
        Query = Query & ", 'Y'"                                    '42 마감여부
        Query = Query & ", 'N'"                                    '43 전송여부
        Query = Query & ", '" & 가맹점정보.지사코드 & "'"          '44 지사코드
        Query = Query & ")"
        ADOCon.Execute Query
    
        마감일자 = Format(DateAdd("d", 1, 마감일자), "YYYY-MM-DD")
    Loop
    
    Screen.MousePointer = 0
    
    Exit Sub
    
ErrRtn:
    Screen.MousePointer = 0
End Sub

'--------------------------------------------------
' 고객정보 변환 - 최종거래일자 변환 오류
' 2010-12-23 까지 임시로 실행
'--------------------------------------------------
Private Sub Set_세탁마진()
    Dim MDBCon  As ADODB.Connection
    
    On Error GoTo ErrRtn
        
    i = 0
    DoEvents
    
    '
    Query = "SELECT * FROM TB_의류분류"
    Set ADORs = New ADODB.Recordset
    ADORs.Open Query, ADOCon, adOpenForwardOnly, adLockReadOnly

    Do Until ADORs.EOF
        i = i + 1
        DoEvents
        
        '---------------------------------------------------------
        ' TB_고객정보
        '---------------------------------------------------------
        Query = "UPDATE TB_입출고 SET 세탁마진 = " & ADORs!세탁마진
        Query = Query & "           , 외주마진 = " & ADORs!외주마진
        Query = Query & "           , 수선마진 = " & ADORs!수선마진
        Query = Query & " WHERE SUBSTRING(의류코드,1,2) = '" & ADORs!의류분류코드 & "'"
        Query = Query & "   AND 세탁마진 = 0"
        ADOCon.Execute Query
        
        ADORs.MoveNext
    Loop
    ADORs.Close
    Set ADORs = Nothing
    
    Exit Sub
    
ErrRtn:
    Call Error_Msg("", Err.Source, Err.Number, Err.Description)

    Screen.MousePointer = 0
End Sub

'-----------------------------------------------------------------------------------------------------------------------------------------
' Function명  : SP_Exec
' 작  성  자  :
' 작  성  일  :
' 파 라 미 터 : ProcName - 프로시저명
'               sValue   - 프로시저 파라미터
'               Err_Num  - 에러번호
'               Err_Desc - 에러명
' 리  턴  값  : Recordset
' 비      고  : Server에 있는 스토어드 프로시저를 실행하기 위한 함수
'-----------------------------------------------------------------------------------------------------------------------------------------
Public Function SP_Exec(ByVal ProcName As String, ByRef sValue() As String, Err_Num As Long, Err_Desc As String) As ADODB.Recordset
    Dim i     As Integer
    Dim MyCom As ADODB.Command
    
    On Error GoTo ErrRtn

    Set SP_Exec = New ADODB.Recordset
    Set MyCom = New ADODB.Command
    
    MyCom.ActiveConnection = HostCon
    MyCom.CommandTimeout = 0
    MyCom.CommandText = ProcName
    MyCom.CommandType = adCmdStoredProc
    
    For i = 1 To MyCom.Parameters.Count - 1
        If IsNull(sValue(i - 1)) Then
            MyCom.Parameters(i).Size = -1
        ElseIf sValue(i - 1) = "" Then
            MyCom.Parameters(i).Size = -1
        Else
            MyCom.Parameters(i).Size = LenH(sValue(i - 1))
        End If
        
        MyCom.Parameters(i) = sValue(i - 1)
    Next i
    
    Set SP_Exec = MyCom.Execute
    Set MyCom = Nothing
    
    Err_Num = 0
    Err_Desc = ""
    
    Exit Function
    
ErrRtn:
    
    Err_Num = Err.Number
    Err_Desc = Err.Description
    
    Set MyCom = Nothing
End Function

'*****************************************************************************
'기    능 : 한글을 2Byte로 처리하여 Mid함수로 처리한다.
'인    수 : sInStr As String Mid처리할 스트링
'           iStart As Integer 시작위치
'           iCnt As Integer Mid할 스트링 숫
'리 턴 값 : Mid된 결과 스트링
'사 용 예 : strTemp = gfMid("무궁화꽃이피었습니다",3,6)
'*****************************************************************************
Public Function MidH(sInStr As String, iStart As Integer, iCnt As Integer) As String
    MidH = StrConv(MidB(StrConv(sInStr, vbFromUnicode), iStart, iCnt), vbUnicode)
End Function

'*****************************************************************************
'기 능    : 한글을 2Byte로 처리하여 Len함수로 처리한다.
'인 수    : strString As String Length를 구할 스트링
'리 턴 값 : 2바이트로 처리된 Length
'사 용 예 : intLen = gfLen("무궁화꽃이피었습니다")
'*****************************************************************************
Public Function LenH(strString As String) As Integer
    LenH = LenB(StrConv(strString, vbFromUnicode))
End Function
